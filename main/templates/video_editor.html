{% extends 'base.html' %}

{% load static %}

{% block title %}Video Editor - SIBI{% endblock title %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/global.css' %}">
{% endblock extra_css %}

{% block content %}
<style>
    .video-editor-content {
      padding: 20px;
    }

    .main-content { 
      display: flex; 
      gap: 20px; 
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .video-panel, .editor-panel { 
      flex: 1; 
      border: 1px solid #ccc; 
      border-radius: 8px; 
      padding: 16px; 
      background: white;
    }
    
    video { 
      width: 100%; 
      border-radius: 8px; 
    }
    
    textarea { 
      width: 100%; 
      height: 100px; 
      margin-bottom: 10px; 
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-family: inherit;
      resize: vertical;
    }
    
    textarea:focus {
      outline: none;
      border-color: #4285f4;
    }
    
    .readonly-box { 
      background: #f8f9fa; 
      padding: 12px; 
      border-radius: 8px; 
      white-space: pre-wrap; 
      height: 120px; 
      overflow-y: auto; 
      margin-bottom: 10px; 
      border: 1px solid #e9ecef;
      font-family: monospace;
    }
    
    .range-control label { 
      font-weight: 600; 
      display: block; 
      margin-top: 15px; 
      margin-bottom: 8px;
      color: #495057;
    }
    
    input[type=range] { 
      width: 100%; 
      margin-bottom: 10px;
    }
    
    .actions { 
      margin-top: 20px; 
      display: flex; 
      gap: 12px; 
      flex-wrap: wrap; 
    }
    
    .actions button { 
      padding: 10px 16px; 
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .actions button:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .actions button:first-child {
      background: #28a745;
      color: white;
    }
    
    .actions button:first-child:hover {
      background: #218838;
    }
    
    .actions button:nth-child(2) {
      background: #17a2b8;
      color: white;
    }
    
    .actions button:nth-child(2):hover {
      background: #138496;
    }
    
    .actions button:nth-child(3) {
      background: #ffc107;
      color: #212529;
    }
    
    .actions button:nth-child(3):hover {
      background: #e0a800;
    }
    
    .actions button:nth-child(4), .actions button:nth-child(5) {
      background: #6c757d;
      color: white;
    }
    
    .actions button:nth-child(4):hover, .actions button:nth-child(5):hover {
      background: #545b62;
    }
    
    .actions button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    h2, h3 {
      color: #495057;
      margin-top: 20px;
      margin-bottom: 10px;
    }

    h2 {
      font-size: 1.25rem;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 8px;
    }

    h3 {
      font-size: 1.1rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }
      
      .video-editor-content {
        padding: 15px;
      }
      
      .actions {
        flex-direction: column;
      }
      
      .actions button {
        width: 100%;
        text-align: center;
      }
    }

    /* Status Anotasi Styling */
    .annotation-status {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .annotation-status h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #495057;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 25px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .status-completed {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-pending {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }

    .annotator-info {
      margin-top: 12px;
      margin-bottom: 0;
      font-size: 0.9rem;
      color: #6c757d;
      padding: 8px 0;
    }
  </style>

<div class="video-editor-content">
<div class="main-content">
  <div class="video-panel">
    <video id="videoPlayer" controls></video>
    <!-- Range -->
    <div class="range-control">
      <label>Waktu video berakhir:</label>
      <input type="range" id="endHandle" step="0.01" value="0" />
      <div>Mulai: <span id="startVal">0</span>s | Berakhir: <span id="endVal">0</span>s</div>
    </div>

    <input type="hidden" id="startTime" value="0" />
    <input type="hidden" id="endTime" />
  </div>

  <div class="editor-panel">
    <!-- Status Anotasi -->
    <div class="annotation-status">
      <h3>Status Anotasi</h3>
      {% if video.is_annotated %}
        <div class="status-badge status-completed">
          <span class="status-text">Sudah Dianotasi</span>
        </div>
      {% else %}
        <div class="status-badge status-pending">
          <span class="status-text">Belum Dianotasi</span>
        </div>
      {% endif %}
      {% if video.annotated_by %}
        <p class="annotator-info">Dianotasi oleh: <strong>{{ video.annotated_by.get_full_name|default:video.annotated_by.username }}</strong></p>
      {% endif %}
    </div>

    <h2>Transkrip Audio Otomatis</h2>
    <div class="readonly-box">{{ automated_transcript|default:"Tidak ada transkrip." }}</div>

    <h3>Alignment</h3>
    <textarea id="alignmentInput">{{ transcript_alignment }}</textarea>

    <h3>SIBI Sentence (Manual)</h3>
    <textarea id="sibiInput">{{ sibi_sentence }}</textarea>

    <h3>Potensi Masalah</h3>
    <textarea id="problemInput">{{ potential_problem }}</textarea>

    <h3>Komentar</h3>
    <textarea id="commentInput">{{ comment }}</textarea>

    <div class="actions">
      <button onclick="saveTranscript()">Simpan Anotasi Saja</button>
      <button onclick="previewTrim()">Preview Video</button>
      <button id="trimButton" onclick="confirmTrim()" disabled>OK</button>
      <button onclick="goToPrevious()">Sebelumnya</button>
      <button id="nextButton" onclick="goToNext()">Selanjutnya</button>
    </div>
    
    <div id="previewStatus" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;">
      <span id="previewMessage"></span>
    </div>
  </div>
</div>

<script>
  let videoTitle = "{{ video.title }}";
  const video = document.getElementById('videoPlayer');
  const endHandle = document.getElementById('endHandle');

  window.onload = function () {
    fetch(`/get_merged_video/${videoTitle}/`)
      .then(res => res.json())
      .then(videoData => {
        if (videoData.merged_video_url) {
          video.src = videoData.merged_video_url;
          video.load();
          video.play();
        }
      });

    fetch(`/get_next_status/{{ video.folder_name }}/{{ video.title }}/`)
      .then(res => res.json())
      .then(data => {
        const nextBtn = document.getElementById('nextButton');
        if (!data.has_next) {
          nextBtn.innerText = '🏁 Selesai';
          nextBtn.onclick = () => { window.location.href = '/'; };
        }
      });
  };

  video.onloadedmetadata = function () {
    const duration = video.duration;
    endHandle.max = duration;
    endHandle.value = duration;
    document.getElementById('startVal').textContent = '0.00';
    document.getElementById('endVal').textContent = duration.toFixed(2);
    document.getElementById('endTime').value = duration;
    
    console.log(`Video loaded: duration=${duration.toFixed(2)} seconds`);
  };

  endHandle.addEventListener('input', () => {
    const val = parseFloat(endHandle.value);
    document.getElementById('endVal').textContent = val.toFixed(2);
    document.getElementById('endTime').value = val;

    // Reset button OK saat slider berubah
    document.getElementById('trimButton').disabled = true;
    
    video.currentTime = 0;
    video.play();
    const interval = setInterval(() => {
      if (video.currentTime >= (val - 0.1)) {
        video.pause(); 
        clearInterval(interval);
      }
    }, 100);
  });

  function saveTranscript() {
    const alignment = document.getElementById('alignmentInput').value;
    const sibi_sentence = document.getElementById('sibiInput').value;
    const problem = document.getElementById('problemInput').value;
    const comment = document.getElementById('commentInput').value;

    fetch(`/save_transcript/${videoTitle}/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        transcript_alignment: alignment,
        sibi_sentence: sibi_sentence,
        potential_problem: problem,
        comment: comment
      })
    }).then(() => alert('Data disimpan!'));
  }

  function previewTrim() {
    const start = 0;
    const end = parseFloat(document.getElementById('endTime').value);
    if (isNaN(end) || start >= end) return alert('Waktu tidak valid');
    
    console.log(`Preview trim: start=${start}, end=${end}`);
    
    // Show preview status
    const statusDiv = document.getElementById('previewStatus');
    const messageSpan = document.getElementById('previewMessage');
    statusDiv.style.display = 'block';
    statusDiv.style.backgroundColor = '#fff3cd';
    statusDiv.style.border = '1px solid #ffeeba';
    statusDiv.style.color = '#856404';
    messageSpan.textContent = '🎬 Preview sedang berjalan... Button OK akan aktif setelah preview selesai.';
    
    // Disable button during preview
    document.getElementById('trimButton').disabled = true;
    
    // Set video ke posisi awal dan play
    video.currentTime = start;
    video.play();
    
    // Set interval untuk monitor posisi video
    const interval = setInterval(() => {
      console.log(`Video time: ${video.currentTime.toFixed(2)}, Target end: ${end.toFixed(2)}`);
      
      // Update progress message
      const progress = ((video.currentTime / end) * 100).toFixed(1);
      messageSpan.textContent = `🎬 Preview berjalan... ${progress}% (${video.currentTime.toFixed(1)}s / ${end.toFixed(1)}s)`;
      
      // Pause saat mencapai end time (dengan toleransi 0.2 detik)
      if (video.currentTime >= (end - 0.2)) {
        video.pause();
        clearInterval(interval);
        
        // Enable button dan show success message
        document.getElementById('trimButton').disabled = false;
        statusDiv.style.backgroundColor = '#d4edda';
        statusDiv.style.border = '1px solid #c3e6cb';
        statusDiv.style.color = '#155724';
        messageSpan.textContent = '✅ Preview selesai! Button OK sudah bisa ditekan untuk memotong video.';
        
        console.log('Preview selesai - Button OK sudah bisa ditekan');
      }
    }, 100);
    
    // Backup: enable button setelah 5 detik jika interval tidak bekerja
    setTimeout(() => {
      clearInterval(interval);
      document.getElementById('trimButton').disabled = false;
      statusDiv.style.backgroundColor = '#d4edda';
      statusDiv.style.border = '1px solid #c3e6cb';
      statusDiv.style.color = '#155724';
      messageSpan.textContent = '✅ Preview timeout - Button OK sudah diaktifkan (backup).';
      console.log('Backup: Button OK diaktifkan setelah 5 detik');
    }, 5000);
  }

  function confirmTrim() {
    const start = 0;
    const end = parseFloat(document.getElementById('endTime').value);
    if (isNaN(end) || start >= end) return alert('Waktu tidak valid');
    
    // Show processing status
    const statusDiv = document.getElementById('previewStatus');
    const messageSpan = document.getElementById('previewMessage');
    statusDiv.style.display = 'block';
    statusDiv.style.backgroundColor = '#cce5ff';
    statusDiv.style.border = '1px solid #99d6ff';
    statusDiv.style.color = '#004085';
    messageSpan.textContent = '⏳ Sedang memproses... Menyimpan anotasi dan memotong video.';
    
    document.getElementById('trimButton').disabled = true;

    const alignment = document.getElementById('alignmentInput')?.value || '';
    const sibi_sentence = document.getElementById('sibiInput')?.value || '';
    const problem = document.getElementById('problemInput')?.value || '';
    const comment = document.getElementById('commentInput')?.value || '';

    // Simpan semua perubahan terlebih dahulu
    fetch(`/save_transcript/${videoTitle}/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        transcript_alignment: alignment,
        sibi_sentence: sibi_sentence,
        potential_problem: problem,
        comment: comment
      })
    })
    .then(res => {
      if (!res.ok) throw new Error('Gagal menyimpan anotasi');
      
      messageSpan.textContent = '⏳ Anotasi berhasil disimpan. Sedang memotong video...';
      
      // Setelah berhasil menyimpan, baru potong video
      return fetch(`/trim_video/${videoTitle}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ start_time: start, end_time: end })
      });
    })
    .then(res => res.json())
    .then(data => {
      statusDiv.style.backgroundColor = '#d4edda';
      statusDiv.style.border = '1px solid #c3e6cb';
      statusDiv.style.color = '#155724';
      messageSpan.textContent = '✅ Berhasil menyimpan anotasi dan memotong video!';
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 3000);
    })
    .catch(err => {
      statusDiv.style.backgroundColor = '#f8d7da';
      statusDiv.style.border = '1px solid #f5c6cb';
      statusDiv.style.color = '#721c24';
      messageSpan.textContent = '❌ Gagal menyimpan atau memotong video! Silakan coba lagi.';
      
      document.getElementById('trimButton').disabled = false;
      console.error(err);
    });
  }

  function goToNext() {
    window.location.href = `/search_video/{{ video.folder_name }}/`;
  }

  function goToPrevious() {
    fetch(`/get_previous_video/{{ video.folder_name }}/`)
      .then(res => res.json())
      .then(data => {
        if (data.previous_video_title) {
          window.location.href = `/video_editor/${data.previous_video_title}/`;
        } else {
          alert('Tidak ada video sebelumnya.');
        }
      });
  }
</script>

</div>
{% endblock content %}